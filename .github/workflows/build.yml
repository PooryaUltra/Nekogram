name: Build Nekogram Blur

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Free Disk Space
      run: |
        echo "Before cleanup:"
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/share/swift
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /opt/hostedtoolcache/go
        sudo rm -rf /opt/hostedtoolcache/node
        sudo rm -rf /imagegeneration
        sudo apt-get clean
        echo "After cleanup:"
        df -h

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26d
        add-to-path: true

    - name: Remove libneko.so and create stub Genuine class
      run: |
        echo "=== Step 1: Remove ALL libneko*.so files ==="
        find . -name "libneko*.so" -type f | while read f; do
          echo "Removing: $f"
          rm -f "$f"
        done
        
        echo "=== Step 2: Find and replace Genuine.java ==="
        GENUINE_JAVA=$(find . -name "Genuine.java" -type f 2>/dev/null | head -1)
        if [ -n "$GENUINE_JAVA" ]; then
          echo "Found: $GENUINE_JAVA"
          GENUINE_DIR=$(dirname "$GENUINE_JAVA")
          GENUINE_PKG=$(grep "^package " "$GENUINE_JAVA" | head -1 | sed 's/package //; s/;//')
          echo "Package: $GENUINE_PKG"
          
          # Create stub Genuine.java that doesn't use native code
          cat > "$GENUINE_JAVA" << GENUINEJAVA
        package $GENUINE_PKG;
        public class Genuine {
            public static final int CHECK_TRUE = 0;
            public static final int CHECK_FALSE = 1;
            public static final int CHECK_FAKE = 2;
            public static final int CHECK_OVERLAY = 3;
            public static final int CHECK_ODEX = 4;
            public static final int CHECK_DEX = 5;
            public static final int CHECK_PROXY = 6;
            public static final int CHECK_ERROR = 7;
            public static final int CHECK_FATAL = 8;
            public static final int CHECK_NOAPK = 9;
            public static int check() { return CHECK_TRUE; }
            public static int version() { return 0; }
        }
        GENUINEJAVA
          echo "Created stub Genuine.java"
          cat "$GENUINE_JAVA"
        else
          echo "Genuine.java not found, searching for other genuine-related files..."
          find . -name "*.java" | xargs grep -l "class Genuine\|Genuine.check" 2>/dev/null | head -5
        fi
        
        echo "=== Step 3: Patch any remaining Genuine.check() calls ==="
        find . -name "*.java" -type f | xargs grep -l "Genuine.check()" 2>/dev/null | while read f; do
          echo "Patching: $f"
          sed -i 's/Genuine.check()/0/g' "$f"
        done
        
        echo "=== Step 4: Remove loadLibrary calls for neko ==="
        find . -name "*.java" -type f | xargs grep -l 'loadLibrary.*"neko' 2>/dev/null | while read f; do
          echo "Patching loadLibrary in: $f"
          # Wrap in try-catch instead of commenting out
          sed -i 's/System.loadLibrary("neko/try { System.loadLibrary("neko/g' "$f"
          sed -i 's/");$/"); } catch (Throwable t) { }/g' "$f"
        done
        
        echo "=== Complete ==="

    - name: Create genuine.h (may not be used for precompiled libs)
      run: |
        echo "=== Creating genuine.h ==="
        mkdir -p "TMessagesProj/jni/integrity"
        cat > "TMessagesProj/jni/integrity/genuine.h" << 'GENUINEOF'
        #ifndef GENUINE_H
        #define GENUINE_H
        #define NO_CHECK_MAPS
        #define NO_CHECK_XPOSED
        #define GENUINE_NAME ""
        #define GENUINE_SIZE 0
        #define GENUINE_HASH 0
        #endif
        GENUINEOF
        echo "Created genuine.h"
        
    - name: Skip native patching (libs are precompiled)
      run: |
        echo "=== Native libraries are precompiled, skipping source patching ==="
        echo "The Colorado check is embedded in precompiled libneko.so"
        echo "We will try to bypass it via Java code instead"
    
    - name: Prepare build
      run: |
        echo "=== Preparing build ==="
        # Don't delete build caches aggressively since native libs won't be rebuilt
        rm -rf TMessagesProj/build/intermediates 2>/dev/null || true
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

    - name: Change app name to Nekogram (not Beta)
      run: |
        echo "=== Changing app name from Nekogram Beta to Nekogram ==="
        
        # Find all strings.xml files and change app_name
        find . -name "strings.xml" -type f | while read f; do
          if grep -q "Nekogram" "$f" 2>/dev/null; then
            echo "Patching: $f"
            sed -i 's/>Nekogram Beta</>Nekogram</g' "$f"
            sed -i 's/>Nekogram X</>Nekogram</g' "$f"
          fi
        done
        
        # Also check AndroidManifest.xml
        find . -name "AndroidManifest.xml" -type f | while read f; do
          if grep -q "label.*Nekogram" "$f" 2>/dev/null; then
            echo "Checking manifest: $f"
          fi
        done
        
        echo "=== App name change complete ==="

    - name: Create Extra.java
      run: |
        cat > TMessagesProj/src/main/java/tw/nekomimi/nekogram/Extra.java << 'EXTRAEOF'
        package tw.nekomimi.nekogram;

        import org.telegram.messenger.BuildConfig;
        import tw.nekomimi.nekogram.helpers.UserHelper;

        public class Extra {
            public static final int APP_ID = 4;
            public static final String APP_HASH = "014b35b6184100b085b0d0572f9b5103";

            public static final String PLAYSTORE_APP_URL = "https://play.google.com/store/apps/details?id=tw.nekomimi.nekogram";

            public static String WS_USER_AGENT = "";
            public static String WS_CONN_HASH = "";
            public static String WS_DEFAULT_DOMAIN = "";

            public static String TWPIC_BOT_USERNAME = "pic_bot";

            public static boolean FORCE_ANALYTICS = false;

            public static String TLV_URL = "https://web.telegram.org";

            public static final long WEBVIEW_BOT_ID = 0L;

            public static boolean isDirectApp() {
                return "release".equals(BuildConfig.BUILD_TYPE) || "debug".equals(BuildConfig.BUILD_TYPE);
            }

            public static UserHelper.BotInfo getHelperBot() {
                return new HelperBotImpl("neko_helper_bot", 0L);
            }

            public static UserHelper.UserInfoBot getUserInfoBot(boolean fallback) {
                return new UserInfoBotImpl(fallback);
            }

            public static boolean isTrustedBot(long id) {
                return id == WEBVIEW_BOT_ID;
            }

            public static class HelperBotImpl implements UserHelper.BotInfo {
                private final String username;
                private final long id;

                public HelperBotImpl(String username, long id) {
                    this.username = username;
                    this.id = id;
                }

                @Override
                public long getId() {
                    return id;
                }

                @Override
                public String getUsername() {
                    return username;
                }
            }

            public static class UserInfoBotImpl extends UserHelper.UserInfoBot {
                private final boolean fallback;

                public UserInfoBotImpl(boolean fallback) {
                    this.fallback = fallback;
                }

                @Override
                public long getId() {
                    return fallback ? 461843263L : 1344636L;
                }

                @Override
                public String getUsername() {
                    return fallback ? "SangMata_BOT" : "userinfobot";
                }

                @Override
                public UserHelper.ParsedPeer parsePeer(String[] lines) {
                    UserHelper.ParsedPeer peer = new UserHelper.ParsedPeer();
                    try {
                        for (String line : lines) {
                            if (line.startsWith("ID: ")) {
                                peer.id = Long.parseLong(line.substring(4).trim());
                            } else if (line.startsWith("First: ")) {
                                peer.first_name = line.substring(7).trim();
                            } else if (line.startsWith("Last: ")) {
                                peer.last_name = line.substring(6).trim();
                            } else if (line.startsWith("Username: @")) {
                                peer.username = line.substring(11).trim();
                            } else if (line.startsWith("Title: ")) {
                                peer.title = line.substring(7).trim();
                            }
                        }
                    } catch (Exception e) {
                        return null;
                    }
                    return peer;
                }
            }
        }
        EXTRAEOF

    - name: Create blur directory
      run: mkdir -p TMessagesProj/src/main/java/tw/nekomimi/nekogram/blur

    - name: Create BlurBubbleHelper.java
      run: |
        cat > TMessagesProj/src/main/java/tw/nekomimi/nekogram/blur/BlurBubbleHelper.java << 'EOF'
        package tw.nekomimi.nekogram.blur;
        import android.graphics.*;
        import android.view.View;
        import org.telegram.messenger.AndroidUtilities;
        import org.telegram.ui.ActionBar.Theme;

        public class BlurBubbleHelper {
            public static boolean blurEnabled = true;
            public static float blurRadius = 25f;
            public static float blurAlpha = 0.6f;
            private static Paint overlayPaint = new Paint(Paint.ANTI_ALIAS_FLAG);
            private static Paint borderPaint = new Paint(Paint.ANTI_ALIAS_FLAG);
            private static Path bubblePath = new Path();
            
            static {
                overlayPaint.setStyle(Paint.Style.FILL);
                borderPaint.setStyle(Paint.Style.STROKE);
                borderPaint.setStrokeWidth(AndroidUtilities.dp(0.5f));
            }
            
            public static void drawBlurBubble(Canvas canvas, View bgView, int l, int t, int r, int b, boolean isOut, boolean isSel, Theme.ResourcesProvider rp) {
                if (!blurEnabled || canvas == null) return;
                int w = r - l, h = b - t;
                if (w <= 0 || h <= 0) return;
                
                try {
                    int save = canvas.save();
                    buildPath(l, t, r, b, isOut);
                    canvas.clipPath(bubblePath);
                    
                    int color = isOut ? 
                        (isSel ? Theme.getColor(Theme.key_chat_outBubbleSelected, rp) : Theme.getColor(Theme.key_chat_outBubble, rp)) : 
                        (isSel ? Theme.getColor(Theme.key_chat_inBubbleSelected, rp) : Theme.getColor(Theme.key_chat_inBubble, rp));
                    
                    overlayPaint.setColor(Color.argb((int)(Color.alpha(color) * blurAlpha), Color.red(color), Color.green(color), Color.blue(color)));
                    borderPaint.setColor(Theme.getColor(isOut ? Theme.key_chat_outBubbleShadow : Theme.key_chat_inBubbleShadow, rp));
                    
                    canvas.drawPath(bubblePath, overlayPaint);
                    canvas.drawPath(bubblePath, borderPaint);
                    canvas.restoreToCount(save);
                } catch (Exception e) {
                    // Silently ignore errors
                }
            }
            
            private static void buildPath(int l, int t, int r, int b, boolean isOut) {
                bubblePath.reset();
                float rad = AndroidUtilities.dp(17);
                float tw = AndroidUtilities.dp(9);
                float th = AndroidUtilities.dp(6);
                
                if (isOut) {
                    float ri = r - tw;
                    bubblePath.moveTo(l + rad, t);
                    bubblePath.lineTo(ri - rad, t);
                    bubblePath.quadTo(ri, t, ri, t + rad);
                    bubblePath.lineTo(ri, b - rad - th);
                    bubblePath.quadTo(ri, b - th / 2, r, b);
                    bubblePath.quadTo(ri, b, ri - rad, b);
                    bubblePath.lineTo(l + rad, b);
                    bubblePath.quadTo(l, b, l, b - rad);
                    bubblePath.lineTo(l, t + rad);
                    bubblePath.quadTo(l, t, l + rad, t);
                } else {
                    float le = l + tw;
                    bubblePath.moveTo(le + rad, t);
                    bubblePath.lineTo(r - rad, t);
                    bubblePath.quadTo(r, t, r, t + rad);
                    bubblePath.lineTo(r, b - rad);
                    bubblePath.quadTo(r, b, r - rad, b);
                    bubblePath.lineTo(le + rad, b);
                    bubblePath.quadTo(le, b, l, b);
                    bubblePath.quadTo(le, b - th / 2, le, b - rad - th);
                    bubblePath.lineTo(le, t + rad);
                    bubblePath.quadTo(le, t, le + rad, t);
                }
                bubblePath.close();
            }
        }
        EOF

    - name: Create BlurBubbleConfig.java
      run: |
        cat > TMessagesProj/src/main/java/tw/nekomimi/nekogram/blur/BlurBubbleConfig.java << 'EOF'
        package tw.nekomimi.nekogram.blur;
        public class BlurBubbleConfig {
            public static boolean blurEnabled = true;
            public static boolean blurIncoming = true;
            public static boolean blurOutgoing = true;
            public static boolean shouldBlurIncoming() { return blurEnabled && blurIncoming; }
            public static boolean shouldBlurOutgoing() { return blurEnabled && blurOutgoing; }
        }
        EOF

    - name: Create google-services.json
      run: |
        JSON='{"project_info":{"project_number":"000","project_id":"neko","storage_bucket":"neko.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000:android:000","android_client_info":{"package_name":"tw.nekomimi.nekogram"}},"api_key":[{"current_key":"AIza000"}],"services":{"appinvite_service":{"other_platform_oauth_client":[]}}},{"client_info":{"mobilesdk_app_id":"1:000:android:001","android_client_info":{"package_name":"tw.nekomimi.nekogram.beta"}},"api_key":[{"current_key":"AIza001"}],"services":{"appinvite_service":{"other_platform_oauth_client":[]}}}],"configuration_version":"1"}'
        echo "$JSON" > TMessagesProj/google-services.json
        echo "$JSON" > TMessagesProj_App/google-services.json

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
    
    - name: Make gradlew executable
      run: chmod +x gradlew

    - name: Clean and Build APK
      run: |
        echo "=== Starting clean build ==="
        ./gradlew clean --no-daemon 2>/dev/null || true
        ./gradlew assembleDebug --no-daemon --warning-mode=none
      env:
        ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
    
    - name: Find APKs
      run: find . -name "*.apk" -type f

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Nekogram-Blur-APK
        path: "**/build/outputs/apk/**/*.apk"
        if-no-files-found: warn
